\documentclass{article}

%\include{macros}

\bibliographystyle{plain}

\usepackage{epsfig}
\usepackage{xcolor}
%%\usepackage{amssymb}
\usepackage{amsmath}

\input{abbrev.tex}

\begin{document}

\title{Accuracy and stability for elliptic operators
  in a finite volume context}
\author{
   \and D. Devendran    \footnotemark[2]
   \and D. T. Graves    \footnotemark[1]
        }

\maketitle

\begin{abstract}

Devendran, et al. \cite{Devendran2017} present an algorithm that
solves Poisson's equation to fourth-order accuracy using an EB grid.
Generalizing somewhat  the framework they present, we can define a
family of elliptic operators.
Here we investigate how the accuracy and stability of this family
of operators varies within its parameter space.

\end{abstract}


\section{Underlying mathematics}

Embedded boundary (EB) grids are formed when one passes an  surface
through a Cartesian mesh.    For sufficiently complex geomtries, these methods
are very attactive because grid generation is a solved problem
even for moving grids \cite{MillerTrebotich2012}.
In the current context, we form the cutting surface as the zero
surface of a function  of space $I(\xbold)$, $\xbold \in R^D$.
For smooth ($I$),  moments can be generated to any
accuracy \cite{Schwartz2015}.

Formally, the underlying description of space
is given by rectangular control volumes on a Cartesian mesh
$\Upsilon_\ibold = [(\ibold-\half {\ubold})h, (\ibold+\half
{\ubold})h], \ibold \in \bigzbold^D$, where $D$ is the dimensionality
of the problem, $h$ is the mesh spacing, and ${\ubold}$ is the vector
whose entries are all one (note we use bold font $\ubold = (u_1, \dots, u_d,
\dots, u_D)$ to indicate a vector quantity).
Given an irregular domain $\Omega$, we
obtain control volumes $V_\ibold = \Upsilon_\ibold \bigcap \Omega$ and
faces $A_{\ibold,d\pm} = A_{\ibold \pm \half \ebold_d}$ which are the
intersection of the boundary of $\partial V_\ibold$ with the
coordinate planes $\{{\xbold}:x_d = (i_d \pm \half)h \}$ ($\ebold_d$ is
the unit vector in the $d$ direction).  We also
define $A_{B,\ibold}$ to be the intersection of the boundary of the
irregular domain with the Cartesian control volume: $A_{B,\ibold}
= \partial \Omega \bigcap \Upsilon_\ibold$. 

We use the compact notation
\begin{align*}
(\xbold - \xbar)^\pbold &= \prod\limits^D_{d=1} (x_d - {\bar x}_d)^{p_d} \\
\pbold! &= \prod\limits^D_{d = 1} p_d!
\end{align*}
Given a $D$-dimensional region of space $\ibold$, 
and a $D$-dimensional integer vector
$\pbold$, we define $m_\ibold^\pbold(\xbar)$ to be the $\pbold^{th}$
moment of $\ibold$ to the point $\xbar$.
\begin{equation}
\mcal_\ibold^\pbold(\xbar)  =  \int\limits_{\ibold} (\xbold - \xbar)^\pbold dV^D.
\label{eqn::volmoment}
\end{equation}
This breaks out into three different cases, volumes, coordinate faces
and irregular faces.
A coordinate face $f_{12}$  is the area where two
volumes ($V_1, V_2$) intersect.
A irregular face $f_V$  is area where the cutting surface
intersects the volume $V$.
The volume moment for a particular power $\pbold$  is
given by
\begin{equation}
  \mcal^\pbold_V = \int\limits_{\ibold} (\xbold - \xbar)^\pbold dV
  \label{eqn::volmom}
\end{equation}
The $\pbold^{th}$ coordinate face moment for the area of where volumes $V_1, V2$
intersect is given by
\begin{equation}
  \mcal^\pbold_{f_{12}} = \int\limits_{A(V_1\bigcap V_2)} (\xbold - \xbar)^\pbold dA.
  \label{eqn::facmom}
\end{equation}
The cutting surface of the boundary $G$ is given by  the zero
surface of the  implicit function ($I(\xbold)= 0$) used in grid generation.
The $\pbold^{th}$ irregular face moment is given by an integral over
the intersection of this cutting surface and the Euclidean volume:
\begin{equation}
  \mcal^\pbold_V = \int\limits_{A(V \bigcap G)} (\xbold - \xbar)^\pbold dA.
  \label{eqn::irrmom}
\end{equation}
These moments are natural products of the grid generation algorithm
in \cite{Schwartz2015}.


\section{Family of finite volume elliptic operators}

Devendran, et al. \cite{Devendran2017} present an algorithm that
solves Poisson's equation to fourth-order accuracy using embedded
boundaries.  Generalizing somewhat  the framework they present, we
present a family of elliptic operators.

We are solving Poisson's equation for field $\psi$, given charge $\rho$:
\begin{equation}
  \nabla \cdot (\nabla \psi) = \rho
  \label{eqn::poisson}
\end{equation}
If we integrate equation \ref{eqn::poisson} and apply the divergence theorem 
over control volumes we get
\begin{equation}
\int_{V_\ibold} \nabla \cdot (\nabla \psi ) dV = \int_{\partial
  V_\ibold} \nabla \psi\cdot \nhat  dA = \int_{V_\ibold} \rho dV
\end{equation}
Without approximation, we can say that the surface integral can be
computed by a sum over the faces that comprise the surface of the
volume.
\begin{equation}
\sum_{f: f \in \partial V_\ibold} \nabla \psi \cdot \nhat dA = \int_{V_\ibold} \rho dV
\end{equation}
Using equations \ref{eqn::faceavg} and \ref{eqn::volavg}, this becomes 
\begin{equation}
\sum_{f: f \in \partial V_\ibold} \avg{\nabla \psi \cdot \nhat}_f A_f
= \avg{\rho}_\ibold V_\ibold
\label{eqn::discretePoisson}
\end{equation}
A finite volume operator is defined by the algorithm to compute the
integral of fluxes at each face.  We have three types of face, open
faces (the faces between two volumes that are aligned with coordinate
directions), domain faces, and cut faces.  For now, let's say we have
homogeneous Neumann boundary conditions at domain and cut faces
$\nabla \psi \cdot \nhat = 0 |\partial \Omega$.  In this case, to
describe the algorithm, we need only describe how to compute 
$<\nabla\psi \cdot \nhat>$ on open faces.

\section{Open face Poisson flux computation with Neumann boundary conditions}

An open face is one that connects two volumes in the solution.  These
faces are aligned with a coordinate direction.   Consider an open face
$\fbold$ aligned with coordinate direction $d$.   We define $\ncal_\fbold$
to be all the volumes within $N_G$ ghost cells of $\fbold$ \footnotemark{3].

\subsection{Taylor expansion around face}

We approximate $\psi$
in the neighborhood of $\xbar$ using a Taylor expansion to order $P_T$:
\begin{equation}
\psi(\xbold)  =  \sum\limits_{p < P_T} C^p (\xbold -\xbar)^p
\label{eqn::taylor}
\end{equation}
where $C^p$ this appropriate Taylor coefficient.  In three dimensions,
\begin{equation}
  C^p =\frac{1}{p!}
      \frac{\partial^{p_0}}{\partial x_0}
      \frac{\partial^{p_1}}{\partial x_1}
      \frac{\partial^{p_2}}{\partial x_2}  (\psi).
\end{equation}
If we know the local Taylor coeffiencts,
the gradient of the field  in direction $d$ is given by
\begin{equation}
  \frac{\partial \psi}{\partial x^d}  =
  \sum\limits_{p < P_T} p^d C^{p} (\xbar -\xbar)^{p-e^d}
\end{equation}

In finite volume  methods, we define grid data to be
averages over volumes and fluxes between volumes are averages over the
faces between volumes.   
For the field $\psi$, the average over the volume $\ibold$ is given by
\begin{equation*}
 V_\ibold <\psi>_\ibold = \int\limits_{V_\ibold} \psi(\xbold) dV
\end{equation*}
If we insert the Taylor expansion \ref{eqn::taylor}, we get a discrete
approximation to the smooth function $\psi$ that is accurate to order $P_T$.
\begin{equation*}
  <\psi>_\ibold = \frac{1}{V_\ibold} \sum\limits_{p < P_T} C^p \mcal^p
  \label{eqn::volavg}.
\end{equation*}
Similarly, integrating the flux over a d-directional face $\fbold$:
\begin{equation*}
  <\nabla \psi_d>_\ibold = \frac{1}{A_\fbold}
  \sum\limits_{p < P_T} p^d C^{p} \mcal^{p-e^d}
  \label{eqn::faceavg}.
\end{equation*}

\subsection{Boundary condition equations}

To solve for the Taylor coefficients, we use the neighboring volumes's
values  to form a system of equations (equation \ref{eqn::volavg})
for each volume $\ibold \in N_f$, the neighborhood of $f$).  Boundary
condition equations are also added to the system.   Since we have
homogeneous Neumann boundary conditions, for every domain face $\bbold$
within $\ncal_\fbold$, we have an equation of the form
\begin{equation}
  <\frac{\partial \psi}{\partial x^d}>_\bbold  =
  \sum\limits_{p < P_T} p^d C^{p} \mcal^{p-e^d}_\bbold = 0.
\end{equation}
Consider a face $\cbold$ which is cut by a surface whose
normal in direction $d$ is given by $n^d(\xbold)$.  We define the
normal moments $\ecal^d$ to be the integral of this product:
\begin{equation}
\ecal^{\pbold, d}_\cbold  =  \int\limits_{A(\cbold)} \xminxbar n^d dA.
\label{eqn::normmoment}
\end{equation}
These normal moments are natural products of the \cite{Schwartz2015}
grid generation algorithm.

\subsection{Moment matrix $M$ and system matrix $A$}

For each $\cbold$ within the $\ncal_\fbold$, we get an equation of the form
\begin{equation}
  \int\limits_{A(\cbold)}  \nabla \psi \cdot \nhat dA =
  \sum\limits_{d < D} \int\limits_{A(\cbold)} \sum_{p < P} p_d C^p
  \xminxbar^{p-e^d} dA
  = 
\sum\limits_{d < D} \sum_{p < P}  p_d C_p \ecal^{p-e^d,d}_\cbold = 0.
\end{equation}
We force there to be enough neighbors so that this system is
overdetermined.  Let's say $\ncal_\fbold$ contains $N_B$ boundary faces and
$N_V$ volumes.   To solve for Taylor coefficients, we have a system 
of the form
\begin{equation*}
M C = P 
\end{equation*}
where $C=\{C^p\}$, 

\begin{equation}
  M_\fbold =\left\{
    \begin{array}{c} 
       m^p_\jbold  \\
       p^d b^{p-e^d}_\bbold  \\
       p^d c^{p-e^d}_\cbold  
    \end{array}
 \right\},
\end{equation}
and
\begin{equation}
  P_\fbold =
    \left\{
    \begin{array}{c} 
       <\psi>_\jbold  \\
      0  \\
      0  
    \end{array}
    \right\}
\end{equation}
for every volume $\jbold$, cut face $\cbold$ and domain face $\bbold$
in $\ncal_\fbold$.
Since the system is overdetermined, we can introduce a 
meaningful weighting matrix $W$ \footnotemark[4]. 
 Choice of $W$
is crucial to the stability of these algorithms
\footnotemark[5].   
We multiply and solve
\begin{equation*}
WMC = WP.
\end{equation*}
Since the system is (deliberately) not square, we approximate
the solution using a Moore-Penrose pseudo-inverse:
\begin{equation}
  C = ((WM)^T(WM))^{-1} (WM)^T P.
\label{eqn::getC}  
\end{equation}
where $A \equiv ((WM)^T(WM))_\fbold$ is the system matrix for face
$\fbold$.

\subsection{Manhattan Distance and the weighting matrix $W$}

All volumes and faces  start with an  index $\ibold \in Z^D$.
We start from face $\fbold$.   Say we want to get
the distance from $\fbold$ with index $\ibold$ to a volume $V_1$
with index $\vbold$.  The distance $D_\fbold(V_1)$ is given by
the Manhattan disance:
\begin{equation}
  D_\fbold(V_1) = \sum\limits_{0 <= d < D} |\vbold^d - \ibold_0^d|.
\label{eqn::uptownFunk}
\end{equation}
$\gbold_\fbold(V_1)$, the weight of the $V_1$ equation in $\fbold$ system
is given by
\begin{equation}
  \gbold_\fbold(V_1)  \equiv \left(\frac{1}{D_\fbold(V_1) } \right)^{P_w},
\label{eqn::weightFunk}  
\end{equation}
where we call $P_w$ the weighting exponent.
The weighting matrix $W_\fbold = \{\{\wbold_{i,j}\}\}$ is diagonal
\begin{equation}
w_{i,j} =
\left(
\begin{array}{ll}
 \gbold_\fbold(V_i) & \mbox{ if } $(i==j)$ \\
 0   & \mbox{ otherwise }
\end{array}
\right)
\end{equation}
Once one has the Taylor coefficients, she can compute the flux through
the open face using  equation \ref{eqn::faceavg}.   Put into matrix
form, we define  vector  $Q_\fbold = \{q^p_\fbold\}$:
\begin{equation}
q^p_\fbold = p^d \mcal^{p-e^d}_\fbold
\end{equation}
and the flux at the face is given by
\begin{equation}
<\nabla \psi>_\fbold = Q C P= Q ((WM)^T(WM))^{-1} (WM)^T  P.
\end{equation}

\subsection{Stencil formulation}
One would like to avoid inverting $A$ every time she wishes to apply
an elliptic operator at a point.  Since everything in sight is a
linear operator, we can simply say that there must exist an equivalent
linear operator $S$ such that
\begin{equation}
(S P)_\fbold = <\nabla \psi>_\fbold = Q C= (Q ((WM)^T(WM))^{-1} (WM)^T  P)_\fbold.
\end{equation}
Since this equivalence has to hold for all $\psi$, the stencil $S$ must be
given by:
\begin{equation}
 S_\fbold = Q C = (Q ((WM)^T(WM))^{-1} (WM)^T  )_\fbold = Q A^{-1} WM^T.
\end{equation}

 
\section{Solvability of the $A$ matrix}

Overton-Katz, et al. \cite{Katz2023} present the above procedure in
the absence of boundary condition equations.   They show that, for
certain values of $P_T$ and $P_N$, the resulting $A$ matrix can have a
severe mismatch between its largest and smallest eigenvalues,
signalling that $A$ is poorly conditioned.    Their data show the
worst solvability issues occur near the domain boundary.    It stands to
reason that including boundary condition equations could improve the
conditioning of the resultant matricies. To test this, we present the
same measurement of condition number for  several values of $P_T$ and
$P_N$ where boundary condition equations are included when they are
part of the neighborhood.




\section{Stability and Conditioning of the entire system}

The matrix $L_{P_T, P_W}$ for a particular polynomial order $P_T$ and
weighting exponent  $P_W$ may be unstable or poorly conditioned.   We
measure both while varying $P_T, P_W$ in both two and three
dimensions.    All these calculations are done using SLEPc and PETc
\cite{petsc-user-ref, petsc-efficient, slepc}.




\section{Conclusions}



\footnotetext[1]{Lawrence Berkeley National Laboratory, Berkeley,
  CA. Research at LBNL was supported financially by the Office of
  Advanced Scientific Computing Research of the US Department of
  Energy under contract number DE-AC02-05CH11231.}
\footnotetext[2]{Ford Motor Company, Sunnyvale, CA.}
\footnotetext[3]{This includes corner volumes.   The neighborhood is
  formed by taking all the volumes within a grown box. The grown box
  is formed by growning the box made from the low and high cells of
  the target face, growing it by $N_G$ and itersecting with the
  domain.  We use the   Chombo
  (\cite{ChomboDesign,ChomboDesignEB,ChomboDesign3})
  box growth semantic. }
\footnotetext[4]{If the matrix $M$ is square, a weighting matrix can
  have no effect and the Moore-Penrose psueudoinverse becomes
  $M^{-1}$.}
\footnotetext[5]{The 
  equations for volumes $\jbold$ where $\xbar_\jbold$ is large
  receive  higher weights.  Diagonal weighting matricies are common.
  Usually, these algorithms define a distance metric $D(\ibold, \jbold)$ for
  two volumes $\ibold$ and $\jbold$.  Typically they make
  $W_{\jbold,\jbold}$ decrease strongly with increasing 
  $D(\ibold,\jbold)$ to assign higher importance to the equations for volumes
  closer to $\ibold$.  Devendran et al. for example \cite{Devendran2017},
  uses a weighting function that varies with $W_{\ibold,\jbold}
  \approx 1./D(\ibold,\jbold)^5$ }.

\renewcommand{\thefootnote}{\fnsymbol{footnote}}\
\bibliography{references}

\end{document}
